<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CloserMetrix — Update Goals</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Inter', sans-serif;
    background: #1a2332;
    color: #e8ecf1;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">

const C = {
  pageBg: "#1a2332", cardBg: "#1e2a3a", cardBorder: "#2a3a4e",
  sectionBg: "#243040", headerBg: "#0f1620",
  textPrimary: "#e8ecf1", textSecondary: "#8899aa", textMuted: "#4a5a6a",
  blue: "#4fc3f7", green: "#66bb6a", orange: "#ffa726",
  red: "#ef5350", yellow: "#ffca28", purple: "#ce93d8", white: "#ffffff",
  teal: "#00D9C0",
};

const fmtCurrency = (n) => {
  if (n == null || isNaN(n)) return "$0";
  if (n >= 1000000) return "$" + (n / 1000000).toFixed(n % 1000000 === 0 ? 0 : 1) + "M";
  if (n >= 1000) return "$" + (n / 1000).toFixed(n % 1000 === 0 ? 0 : 1) + "K";
  return "$" + n.toLocaleString();
};

const parseCurrency = (str) => {
  if (!str) return 0;
  const cleaned = str.replace(/[^0-9.]/g, "");
  return parseFloat(cleaned) || 0;
};

function App() {
  // Read URL params for pre-fill and client info
  const params = new URLSearchParams(window.location.search);
  const clientId = params.get("client_id") || "";
  const clientName = params.get("client_name") || "Your Business";
  const webhookUrl = params.get("webhook") || "";

  const prefillMonthly = parseFloat(params.get("monthly_goal")) || 0;
  const prefillQuarterly = parseFloat(params.get("quarterly_goal")) || 0;
  const prefillYearly = parseFloat(params.get("yearly_goal")) || 0;

  const [monthly, setMonthly] = React.useState(prefillMonthly || "");
  const [quarterly, setQuarterly] = React.useState(prefillQuarterly || "");
  const [yearly, setYearly] = React.useState(prefillYearly || "");

  // Track which fields were manually edited (to not overwrite them)
  const [manualQ, setManualQ] = React.useState(prefillQuarterly > 0);
  const [manualY, setManualY] = React.useState(prefillYearly > 0);
  const [manualM, setManualM] = React.useState(prefillMonthly > 0);

  // Track last field edited to know which direction to auto-calc
  const [lastEdited, setLastEdited] = React.useState(null);

  const [sending, setSending] = React.useState({});
  const [success, setSuccess] = React.useState({});
  const [error, setError] = React.useState({});

  const handleMonthlyChange = (val) => {
    const num = parseCurrency(val);
    setMonthly(num || "");
    setLastEdited("monthly");
    setManualM(true);
    // Auto-calc quarterly and yearly if not manually set
    if (!manualQ) setQuarterly(num * 3);
    if (!manualY) setYearly(num * 12);
    // If both were manual, still auto-calc since monthly is the "driver"
    if (manualQ && manualY) {
      // Don't override — user set those intentionally
    }
  };

  const handleQuarterlyChange = (val) => {
    const num = parseCurrency(val);
    setQuarterly(num || "");
    setLastEdited("quarterly");
    setManualQ(true);
    if (!manualM) setMonthly(Math.round(num / 3));
    if (!manualY) setYearly(num * 4);
  };

  const handleYearlyChange = (val) => {
    const num = parseCurrency(val);
    setYearly(num || "");
    setLastEdited("yearly");
    setManualY(true);
    if (!manualM) setMonthly(Math.round(num / 12));
    if (!manualQ) setQuarterly(Math.round(num / 4));
  };

  // Reset auto-calc locks
  const resetLocks = () => {
    setManualM(false);
    setManualQ(false);
    setManualY(false);
    setLastEdited(null);
  };

  const sendUpdate = async (fields) => {
    const key = Object.keys(fields).join(",");
    setSending(s => ({ ...s, [key]: true }));
    setError(e => ({ ...e, [key]: null }));
    setSuccess(s => ({ ...s, [key]: false }));

    const payload = {
      client_id: clientId,
      client_name: clientName,
      ...fields,
      updated_at: new Date().toISOString(),
    };

    if (!webhookUrl) {
      // No webhook — just show success for demo/testing
      setTimeout(() => {
        setSending(s => ({ ...s, [key]: false }));
        setSuccess(s => ({ ...s, [key]: true }));
        setTimeout(() => setSuccess(s => ({ ...s, [key]: false })), 3000);
      }, 800);
      console.log("Goal update (no webhook configured):", payload);
      return;
    }

    try {
      const res = await fetch(webhookUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
      if (!res.ok) throw new Error("Failed to update");
      setSending(s => ({ ...s, [key]: false }));
      setSuccess(s => ({ ...s, [key]: true }));
      setTimeout(() => setSuccess(s => ({ ...s, [key]: false })), 3000);
    } catch (err) {
      setSending(s => ({ ...s, [key]: false }));
      setError(e => ({ ...e, [key]: err.message }));
    }
  };

  const goalRow = (label, value, onChange, onUpdate, fieldKey, color) => {
    const isUpdating = sending[fieldKey];
    const isSuccess = success[fieldKey];
    const hasError = error[fieldKey];

    return (
      <div style={{ marginBottom: 16 }}>
        <label style={{
          display: "block", fontSize: 11, fontWeight: 600, color,
          textTransform: "uppercase", letterSpacing: 0.5, marginBottom: 6,
        }}>{label}</label>
        <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
          <div style={{ position: "relative", flex: 1 }}>
            <span style={{
              position: "absolute", left: 12, top: "50%", transform: "translateY(-50%)",
              color: C.textMuted, fontSize: 16, fontWeight: 600, pointerEvents: "none",
            }}>$</span>
            <input
              type="text"
              value={value ? Number(value).toLocaleString() : ""}
              onChange={(e) => {
                const raw = e.target.value.replace(/[^0-9]/g, "");
                onChange(raw);
              }}
              placeholder="0"
              style={{
                width: "100%",
                background: C.cardBg,
                border: `1px solid ${C.cardBorder}`,
                borderRadius: 6,
                padding: "12px 12px 12px 28px",
                color: C.textPrimary,
                fontSize: 18,
                fontWeight: 600,
                fontFamily: "Inter, sans-serif",
                outline: "none",
                transition: "border-color 0.2s",
              }}
              onFocus={(e) => e.target.style.borderColor = color}
              onBlur={(e) => e.target.style.borderColor = C.cardBorder}
            />
          </div>
          <button
            onClick={onUpdate}
            disabled={isUpdating || !value}
            style={{
              background: isSuccess ? C.green : "transparent",
              border: `1px solid ${isSuccess ? C.green : color}`,
              borderRadius: 6,
              padding: "12px 14px",
              color: isSuccess ? "#fff" : color,
              fontSize: 11,
              fontWeight: 600,
              fontFamily: "Inter, sans-serif",
              cursor: isUpdating || !value ? "not-allowed" : "pointer",
              whiteSpace: "nowrap",
              textTransform: "uppercase",
              letterSpacing: 0.3,
              opacity: !value ? 0.4 : 1,
              transition: "all 0.2s",
              minWidth: 80,
            }}
          >
            {isUpdating ? "..." : isSuccess ? "✓ Saved" : "Update"}
          </button>
        </div>
        {hasError && (
          <div style={{ fontSize: 11, color: C.red, marginTop: 4 }}>{hasError}</div>
        )}
      </div>
    );
  };

  const allKey = "monthly_goal,quarterly_goal,yearly_goal";
  const allUpdating = sending[allKey];
  const allSuccess = success[allKey];

  return (
    <div style={{
      width: "100%",
      maxWidth: 460,
      margin: "0 auto",
    }}>
      {/* Header */}
      <div style={{
        background: C.headerBg,
        borderRadius: "8px 8px 0 0",
        padding: "16px 20px",
        display: "flex",
        alignItems: "center",
        justifyContent: "space-between",
        borderBottom: `1px solid ${C.cardBorder}`,
      }}>
        <div>
          <div style={{
            fontSize: 14, fontWeight: 700, color: C.teal,
            letterSpacing: 1, textTransform: "uppercase",
          }}>CloserMetrix</div>
          <div style={{
            fontSize: 11, color: C.textSecondary, marginTop: 2,
          }}>Revenue Goals</div>
        </div>
        {clientName && clientName !== "Your Business" && (
          <div style={{
            fontSize: 12, color: C.textSecondary,
            background: C.sectionBg, padding: "4px 10px",
            borderRadius: 4, fontWeight: 500,
          }}>{clientName}</div>
        )}
      </div>

      {/* Section Header */}
      <div style={{
        background: C.sectionBg,
        padding: "10px 20px",
        textAlign: "center",
        borderBottom: `1px solid ${C.cardBorder}`,
      }}>
        <span style={{
          fontSize: 13, fontWeight: 600, color: C.textPrimary,
          textTransform: "uppercase", letterSpacing: 1,
        }}>Set Your Revenue Goals</span>
      </div>

      {/* Body */}
      <div style={{
        background: C.cardBg,
        border: `1px solid ${C.cardBorder}`,
        borderTop: "none",
        borderRadius: "0 0 8px 8px",
        padding: "24px 20px 16px",
      }}>
        {/* Info text */}
        <p style={{
          fontSize: 12, color: C.textSecondary, marginBottom: 20,
          lineHeight: 1.5,
        }}>
          Enter any goal and the others auto-calculate. Override any
          auto-calculated value by typing your own number.
          {" "}
          <span
            onClick={resetLocks}
            style={{ color: C.teal, cursor: "pointer", textDecoration: "underline" }}
          >Reset auto-calc</span>
        </p>

        {/* Goal Inputs */}
        {goalRow(
          "Monthly Revenue Goal",
          monthly,
          handleMonthlyChange,
          () => sendUpdate({ monthly_goal: Number(monthly) }),
          "monthly_goal",
          C.orange
        )}

        {goalRow(
          "Quarterly Revenue Goal",
          quarterly,
          handleQuarterlyChange,
          () => sendUpdate({ quarterly_goal: Number(quarterly) }),
          "quarterly_goal",
          C.yellow
        )}

        {goalRow(
          "Yearly Revenue Goal",
          yearly,
          handleYearlyChange,
          () => sendUpdate({ yearly_goal: Number(yearly) }),
          "yearly_goal",
          C.green
        )}

        {/* Divider */}
        <div style={{
          height: 1, background: C.cardBorder, margin: "8px 0 16px",
        }} />

        {/* Update All button */}
        <button
          onClick={() => sendUpdate({
            monthly_goal: Number(monthly),
            quarterly_goal: Number(quarterly),
            yearly_goal: Number(yearly),
          })}
          disabled={allUpdating || (!monthly && !quarterly && !yearly)}
          style={{
            width: "100%",
            background: allSuccess ? C.green : C.teal,
            border: "none",
            borderRadius: 6,
            padding: "14px",
            color: "#fff",
            fontSize: 14,
            fontWeight: 700,
            fontFamily: "Inter, sans-serif",
            cursor: allUpdating || (!monthly && !quarterly && !yearly) ? "not-allowed" : "pointer",
            textTransform: "uppercase",
            letterSpacing: 0.5,
            opacity: (!monthly && !quarterly && !yearly) ? 0.4 : 1,
            transition: "all 0.2s",
          }}
        >
          {allUpdating ? "Updating..." : allSuccess ? "✓ All Goals Saved" : "Update All Goals"}
        </button>

        {/* Current goals summary (if prefilled) */}
        {(prefillMonthly > 0 || prefillQuarterly > 0 || prefillYearly > 0) && (
          <div style={{
            marginTop: 16, padding: "12px 14px",
            background: C.sectionBg, borderRadius: 6,
            border: `1px solid ${C.cardBorder}`,
          }}>
            <div style={{
              fontSize: 10, fontWeight: 600, color: C.textMuted,
              textTransform: "uppercase", letterSpacing: 0.5, marginBottom: 8,
            }}>Current Saved Goals</div>
            <div style={{ display: "flex", justifyContent: "space-between" }}>
              {prefillMonthly > 0 && (
                <div style={{ textAlign: "center" }}>
                  <div style={{ fontSize: 10, color: C.orange }}>Monthly</div>
                  <div style={{ fontSize: 14, fontWeight: 600, color: C.textPrimary }}>
                    {fmtCurrency(prefillMonthly)}
                  </div>
                </div>
              )}
              {prefillQuarterly > 0 && (
                <div style={{ textAlign: "center" }}>
                  <div style={{ fontSize: 10, color: C.yellow }}>Quarterly</div>
                  <div style={{ fontSize: 14, fontWeight: 600, color: C.textPrimary }}>
                    {fmtCurrency(prefillQuarterly)}
                  </div>
                </div>
              )}
              {prefillYearly > 0 && (
                <div style={{ textAlign: "center" }}>
                  <div style={{ fontSize: 10, color: C.green }}>Yearly</div>
                  <div style={{ fontSize: 14, fontWeight: 600, color: C.textPrimary }}>
                    {fmtCurrency(prefillYearly)}
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

        {/* Footer */}
        <p style={{
          fontSize: 10, color: C.textMuted, textAlign: "center",
          marginTop: 16,
        }}>
          Goals are saved to your CloserMetrix dashboard
        </p>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
